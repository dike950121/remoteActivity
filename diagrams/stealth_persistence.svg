<svg width="1400" height="1000" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <style>
      .title { font-family: Arial, sans-serif; font-size: 20px; font-weight: bold; fill: #2c3e50; }
      .subtitle { font-family: Arial, sans-serif; font-size: 14px; font-weight: bold; fill: #34495e; }
      .text { font-family: Arial, sans-serif; font-size: 12px; fill: #2c3e50; }
      .small-text { font-family: Arial, sans-serif; font-size: 10px; fill: #7f8c8d; }
      .stealth-box { fill: #e74c3c; stroke: #c0392b; stroke-width: 2; }
      .persist-box { fill: #f39c12; stroke: #e67e22; stroke-width: 2; }
      .evasion-box { fill: #9b59b6; stroke: #8e44ad; stroke-width: 2; }
      .protection-box { fill: #2ecc71; stroke: #27ae60; stroke-width: 2; }
      .decision-diamond { fill: #3498db; stroke: #2980b9; stroke-width: 2; }
      .arrow { stroke: #34495e; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
      .conditional { stroke: #e67e22; stroke-width: 2; fill: none; marker-end: url(#arrowhead); stroke-dasharray: 5,5; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#34495e" />
    </marker>
  </defs>
  
  <!-- Title -->
  <text x="700" y="30" text-anchor="middle" class="title">Stealth &amp; Persistence Mechanisms Flow</text>
  
  <!-- Initial Execution -->
  <rect x="600" y="60" width="200" height="50" rx="5" class="stealth-box"/>
  <text x="700" y="80" text-anchor="middle" class="text">Payload Initial Execution</text>
  <text x="700" y="95" text-anchor="middle" class="small-text">Silent, no admin required</text>
  
  <!-- Environment Detection -->
  <polygon points="700,130 750,160 700,190 650,160" class="decision-diamond"/>
  <text x="700" y="165" text-anchor="middle" class="text">Detect Analysis</text>
  <text x="700" y="175" text-anchor="middle" class="text">Environment?</text>
  
  <!-- Analysis Detection Branch -->
  <rect x="900" y="140" width="200" height="80" rx="5" class="evasion-box"/>
  <text x="1000" y="165" text-anchor="middle" class="text">Anti-Analysis Actions</text>
  <text x="910" y="180" class="small-text">• VM detection (VMware, VBox)</text>
  <text x="910" y="195" class="small-text">• Sandbox detection (Cuckoo)</text>
  <text x="910" y="210" class="small-text">• Debugger detection</text>
  
  <!-- Evasion Actions -->
  <rect x="1150" y="140" width="200" height="80" rx="5" class="evasion-box"/>
  <text x="1250" y="165" text-anchor="middle" class="text">Evasion Response</text>
  <text x="1160" y="180" class="small-text">• Self-termination</text>
  <text x="1160" y="195" class="small-text">• Dormant state</text>
  <text x="1160" y="210" class="small-text">• Decoy execution</text>
  
  <!-- Normal Execution Path -->
  <rect x="450" y="250" width="200" height="80" rx="5" class="stealth-box"/>
  <text x="550" y="275" text-anchor="middle" class="text">Code Obfuscation</text>
  <text x="460" y="290" class="small-text">• String encryption (Base64/Hex)</text>
  <text x="460" y="305" class="small-text">• Control flow obfuscation</text>
  <text x="460" y="320" class="small-text">• API call obfuscation</text>
  
  <rect x="700" y="250" width="200" height="80" rx="5" class="stealth-box"/>
  <text x="800" y="275" text-anchor="middle" class="text">Process Injection</text>
  <text x="710" y="290" class="small-text">• Process hollowing</text>
  <text x="710" y="305" class="small-text">• DLL injection</text>
  <text x="710" y="320" class="small-text">• Reflective DLL loading</text>
  
  <rect x="950" y="250" width="200" height="80" rx="5" class="stealth-box"/>
  <text x="1050" y="275" text-anchor="middle" class="text">Memory Protection</text>
  <text x="960" y="290" class="small-text">• Heap encryption</text>
  <text x="960" y="305" class="small-text">• Stack obfuscation</text>
  <text x="960" y="320" class="small-text">• Anti-dump techniques</text>
  
  <!-- Persistence Layer -->
  <rect x="50" y="380" width="1300" height="120" rx="10" class="persist-box" opacity="0.1"/>
  <text x="700" y="405" text-anchor="middle" class="subtitle">PERSISTENCE MECHANISMS</text>
  
  <!-- Registry Persistence -->
  <rect x="80" y="420" width="180" height="70" rx="5" class="persist-box"/>
  <text x="170" y="440" text-anchor="middle" class="text">Registry Persistence</text>
  <text x="90" y="455" class="small-text">• HKCU\Run keys</text>
  <text x="90" y="470" class="small-text">• COM hijacking</text>
  <text x="90" y="485" class="small-text">• WMI subscriptions</text>
  
  <!-- Scheduled Tasks -->
  <rect x="280" y="420" width="180" height="70" rx="5" class="persist-box"/>
  <text x="370" y="440" text-anchor="middle" class="text">Scheduled Tasks</text>
  <text x="290" y="455" class="small-text">• User login triggers</text>
  <text x="290" y="470" class="small-text">• System event triggers</text>
  <text x="290" y="485" class="small-text">• Hidden task creation</text>
  
  <!-- Service Persistence -->
  <rect x="480" y="420" width="180" height="70" rx="5" class="persist-box"/>
  <text x="570" y="440" text-anchor="middle" class="text">Service Installation</text>
  <text x="490" y="455" class="small-text">• Disguised as legit service</text>
  <text x="490" y="470" class="small-text">• Auto-restart policies</text>
  <text x="490" y="485" class="small-text">• Service protection</text>
  
  <!-- File System Hiding -->
  <rect x="680" y="420" width="180" height="70" rx="5" class="persist-box"/>
  <text x="770" y="440" text-anchor="middle" class="text">File System Hiding</text>
  <text x="690" y="455" class="small-text">• NTFS alternate streams</text>
  <text x="690" y="470" class="small-text">• File attribute manipulation</text>
  <text x="690" y="485" class="small-text">• Rootkit-style hiding</text>
  
  <!-- Kernel Persistence -->
  <rect x="880" y="420" width="180" height="70" rx="5" class="persist-box"/>
  <text x="970" y="440" text-anchor="middle" class="text">Kernel-Level Storage</text>
  <text x="890" y="455" class="small-text">• Driver installation</text>
  <text x="890" y="470" class="small-text">• Kernel callbacks</text>
  <text x="890" y="485" class="small-text">• Deep system hooks</text>
  
  <!-- Watchdog -->
  <rect x="1080" y="420" width="180" height="70" rx="5" class="persist-box"/>
  <text x="1170" y="440" text-anchor="middle" class="text">Watchdog Process</text>
  <text x="1090" y="455" class="small-text">• Mutual monitoring</text>
  <text x="1090" y="470" class="small-text">• Auto-restart</text>
  <text x="1090" y="485" class="small-text">• Process resurrection</text>
  
  <!-- Protection Layer -->
  <rect x="50" y="520" width="1300" height="120" rx="10" class="protection-box" opacity="0.1"/>
  <text x="700" y="545" text-anchor="middle" class="subtitle">PROTECTION MECHANISMS</text>
  
  <!-- Process Protection -->
  <rect x="80" y="560" width="200" height="70" rx="5" class="protection-box"/>
  <text x="180" y="580" text-anchor="middle" class="text">Process Protection</text>
  <text x="90" y="595" class="small-text">• Handle protection</text>
  <text x="90" y="610" class="small-text">• Anti-termination hooks</text>
  <text x="90" y="625" class="small-text">• UIPI bypass</text>
  
  <!-- File Protection -->
  <rect x="300" y="560" width="200" height="70" rx="5" class="protection-box"/>
  <text x="400" y="580" text-anchor="middle" class="text">File Protection</text>
  <text x="310" y="595" class="small-text">• File locking mechanisms</text>
  <text x="310" y="610" class="small-text">• Permission manipulation</text>
  <text x="310" y="625" class="small-text">• Mini-filter driver</text>
  
  <!-- Registry Protection -->
  <rect x="520" y="560" width="200" height="70" rx="5" class="protection-box"/>
  <text x="620" y="580" text-anchor="middle" class="text">Registry Protection</text>
  <text x="530" y="595" class="small-text">• Key access control</text>
  <text x="530" y="610" class="small-text">• Registry callbacks</text>
  <text x="530" y="625" class="small-text">• Value encryption</text>
  
  <!-- Network Protection -->
  <rect x="740" y="560" width="200" height="70" rx="5" class="protection-box"/>
  <text x="840" y="580" text-anchor="middle" class="text">Network Protection</text>
  <text x="750" y="595" class="small-text">• Traffic encryption</text>
  <text x="750" y="610" class="small-text">• Protocol obfuscation</text>
  <text x="750" y="625" class="small-text">• Domain fronting</text>
  
  <!-- Self-Defense -->
  <rect x="960" y="560" width="200" height="70" rx="5" class="protection-box"/>
  <text x="1060" y="580" text-anchor="middle" class="text">Self-Defense</text>
  <text x="970" y="595" class="small-text">• Security tool detection</text>
  <text x="970" y="610" class="small-text">• AV/EDR evasion</text>
  <text x="970" y="625" class="small-text">• Behavioral adaptation</text>
  
  <!-- Monitoring and Response -->
  <rect x="300" y="680" width="800" height="100" rx="10" class="evasion-box" opacity="0.1"/>
  <text x="700" y="705" text-anchor="middle" class="subtitle">CONTINUOUS MONITORING &amp; RESPONSE</text>
  
  <!-- Detection Response -->
  <polygon points="500,730 550,760 500,790 450,760" class="decision-diamond"/>
  <text x="500" y="765" text-anchor="middle" class="text">Threat Detected?</text>
  
  <!-- Response Actions -->
  <rect x="600" y="720" width="180" height="80" rx="5" class="evasion-box"/>
  <text x="690" y="745" text-anchor="middle" class="text">Response Actions</text>
  <text x="610" y="760" class="small-text">• Temporary dormancy</text>
  <text x="610" y="775" class="small-text">• Process migration</text>
  <text x="610" y="790" class="small-text">• Communication pause</text>
  
  <!-- Recovery -->
  <rect x="820" y="720" width="180" height="80" rx="5" class="evasion-box"/>
  <text x="910" y="745" text-anchor="middle" class="text">Recovery Process</text>
  <text x="830" y="760" class="small-text">• Environment re-check</text>
  <text x="830" y="775" class="small-text">• Gradual re-activation</text>
  <text x="830" y="790" class="small-text">• Stealth verification</text>
  
  <!-- Activity Confirmation -->
  <rect x="450" y="840" width="500" height="60" rx="5" class="stealth-box"/>
  <text x="700" y="865" text-anchor="middle" class="text">Activity Confirmation Signal</text>
  <text x="460" y="880" class="small-text">• Periodic heartbeat to C2 server</text>
  <text x="460" y="895" class="small-text">• Encrypted status updates with system activity proof</text>
  
  <!-- Arrows and Flow -->
  <line x1="700" y1="110" x2="700" y2="130" class="arrow"/>
  <line x1="750" y1="160" x2="900" y2="180" class="conditional"/>
  <line x1="1100" y1="180" x2="1150" y2="180" class="arrow"/>
  <line x1="650" y1="160" x2="550" y2="250" class="arrow"/>
  <line x1="700" y1="190" x2="800" y2="250" class="arrow"/>
  <line x1="750" y1="160" x2="1050" y2="250" class="conditional"/>
  
  <!-- Persistence connections -->
  <line x1="550" y1="330" x2="170" y2="420" class="arrow"/>
  <line x1="650" y1="330" x2="370" y2="420" class="arrow"/>
  <line x1="750" y1="330" x2="570" y2="420" class="arrow"/>
  <line x1="850" y1="330" x2="770" y2="420" class="arrow"/>
  <line x1="950" y1="330" x2="970" y2="420" class="arrow"/>
  <line x1="1050" y1="330" x2="1170" y2="420" class="arrow"/>
  
  <!-- Protection connections -->
  <line x1="170" y1="490" x2="180" y2="560" class="arrow"/>
  <line x1="370" y1="490" x2="400" y2="560" class="arrow"/>
  <line x1="570" y1="490" x2="620" y2="560" class="arrow"/>
  <line x1="770" y1="490" x2="840" y2="560" class="arrow"/>
  <line x1="970" y1="490" x2="1060" y2="560" class="arrow"/>
  
  <!-- Monitoring flow -->
  <line x1="500" y1="630" x2="500" y2="730" class="arrow"/>
  <line x1="550" y1="760" x2="600" y2="760" class="conditional"/>
  <line x1="780" y1="760" x2="820" y2="760" class="arrow"/>
  <line x1="700" y1="800" x2="700" y2="840" class="arrow"/>
  
  <!-- Labels -->
  <text x="825" y="155" class="small-text">YES</text>
  <text x="575" y="200" class="small-text">NO</text>
  <text x="575" y="755" class="small-text">YES</text>
  <text x="425" y="755" class="small-text">NO</text>
  
  <!-- Legend -->
  <rect x="50" y="930" width="600" height="50" rx="3" fill="#ecf0f1" stroke="#bdc3c7"/>
  <text x="60" y="950" class="small-text">Legend:</text>
  <text x="60" y="965" class="small-text">Solid arrows = Normal flow | Dashed arrows = Conditional/Threat response</text>
  <text x="60" y="980" class="small-text">All mechanisms work together to ensure payload survival and stealth operation</text>
</svg>